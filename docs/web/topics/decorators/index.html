<!doctype html>
<html lang="en-US" class="no-wp-admin">

<!-- Mirrored from chriskrycho.com/web/topics/decorators/ by HTTrack Website Copier/3.x [XR&CO'2013], Wed, 01 Jan 2014 02:58:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
   <title>
      decorators &raquo; Designgineering &raquo; Chris Krycho   </title>

   <!-- Set document meta -->
   <meta charset="UTF-8" />

   <!-- Mobile devices should view the screen at their native width -->
   <meta name='viewport' content='width=device-width,initial-scale=1.0' />

   <!-- Styles -->
   <link rel="stylesheet" type="text/css" media="screen" href="../../wp-content/themes/ck-web/style.css" />
   <link rel="stylesheet" type="text/css" media="screen" href="../../../utilities/tooltip/jquery.tooltip.css"

   <!-- Authorship -->
   <link rel="author" href="https://plus.google.com/u/0/100517719789069874571/" />
   
   <!-- All Javascript (including JQuery) functionality -->
   <script type="text/javascript" src="http://use.typekit.com/aqh6miw.js"></script>

   <!-- jQuery -->
   <script type="text/javascript" src="../../../utilities/jquery.min.js"></script>
   <script type="text/javascript" src="../../../utilities/tooltip/jquery.tooltip.min.js"></script>
   <script type="text/javascript" src="../../../utilities/custom-functions.js"></script>

   <!-- IE Fixes -->
   <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <link rel="stylesheet" type="text/css" media="screen" href="/styles/ie.css" />
   <![endif]-->
   
   
<!-- This site is optimized with the Yoast WordPress SEO plugin v1.4.22 - http://yoast.com/wordpress/seo/ -->
<link rel="canonical" href="index.html" />
<!-- / Yoast WordPress SEO plugin. -->


            <script type="text/javascript">//<![CDATA[
            // Google Analytics for WordPress by Yoast v4.3.3 | http://yoast.com/wordpress/google-analytics/
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-10702079-9']);
				            _gaq.push(['_trackPageview']);
            (function () {
                var ga = document.createElement('script');
                ga.type = 'text/javascript';
                ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';

                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(ga, s);
            })();
            //]]></script>
			<link rel="alternate" type="application/rss+xml" title="Designgineering &raquo; decorators Tag Feed" href="feed/index.html" />
<link rel='stylesheet' id='wp-syntax-css-css'  href='../../wp-content/plugins/wp-syntax/css/wp-syntax5152.css?ver=1.0' type='text/css' media='all' />
<meta name="generator" content="WordPress 3.9-alpha" />
<script type="text/javascript" src="../../wp-content/plugins/wp-syntax-effects/js/wp-syntax-effects.js"></script>
</head>
<body>
<style>
#archival { font-family: cronos-pro, "Century Gothic", sans-serif; color: white; font-size: 1.2em; padding: 0 1em; text-align: center; }
#archival a:hover, #archival a:active { border-bottom: 1px solid white; color: white; }
</style>
<div id='archival'>This version of the site is now archived. See the next iteration at <a href='https://v4.chriskrycho.com'>v4.chriskrycho.com</a>.</div>
<div id="decorative-wrapper">


   <!--[if lt IE 9]>
   <div id="nav-wrapper">
   <![endif]-->
   
   <nav id="site-nav" class="menu-main-nav-container"><ul id="menu-main-nav" class="menu"><li id="menu-item-12" class="level-1 menu-item menu-item-type-post_type menu-item-object-page menu-item-12"><a href="../../work/index.html" >Work</a></li>
<li id="menu-item-219" class="level-1 menu-item menu-item-type-post_type menu-item-object-page menu-item-219"><a href="../../tools/index.html" >Tools</a></li>
<li id="menu-item-858" class="level-1 menu-item menu-item-type-taxonomy menu-item-object-category menu-item-858"><a href="../../projects/index.html" >Projects</a></li>
<li id="menu-item-11" class="level-1 hide menu-item menu-item-type-post_type menu-item-object-page menu-item-11"><a href="../../process/index.html" >Process</a></li>
<li id="menu-item-10" class="level-1 menu-item menu-item-type-post_type menu-item-object-page menu-item-10"><a href="../../web-professionals/index.html" >Web Professionals</a></li>
</ul></nav>   
   <!--[if lt IE 9]>
   </div>
   <![endif]-->

   <header id="site-header">
      <h1><a href="../../index.html">Designgineering</a></h1>
      <h2><span class="italic">web design &amp; development <span class="break">by <a href='../../../index.html'>Chris Krycho</a></span></span></h2>
   </header>
   
         
      <div id="content-header">Topic: &ldquo;decorators&rdquo;</div>         <article>

            <header>
               <h1>
                  <a href="../../great-deglobalization/index.html">The Great Deglobalization</a>               </h1>
            </header>

                        <div class="content-meta">

                              <p class="pubdate">Published: <a href="../../great-deglobalization/index.html" class="permalink">August 31, 2013</a></p>

                              <p class="comments">Comments: <a href="../../great-deglobalization/index.html#comments" class="permalink">2</a></p>

                              <p class="categories">Filed under: <a href="../../posts/index.html" title="View all posts in Posts" rel="category tag">Posts</a></p>

                              <p class="tags">Topics: <a href="index.html" rel="tag">decorators</a>, <a href="../global-variables/index.html" rel="tag">global variables</a>, <a href="../metaprogramming/index.html" rel="tag">metaprogramming</a>, <a href="../python/index.html" rel="tag">Python</a>, <a href="../refactoring/index.html" rel="tag">refactoring</a></p>
                           </div>
            
                        <div class="content hyphenate">

               <p>For nearly all of August, I have been helping a colleague work on a massive code refactoring project. The company I am consulting for relies on a decades-old (though quite robust) piece of engineering modeling software. The software was written in FORTRAN77 in the mid-to-late 1980s, as was common for such packages at the time. It is apparent that it was <em>not</em> written by competent software developers, however: the entire code-base smacks of fastest-way-to-get-it-to-work thinking. All of the code&#8212;all 4,000+ lines of it&#8212;came in a single file. Every variable in the program is global.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>
<p>Yes, you read that right. <em>Every variable in the program is global.</em></p>
<p>Since no one at the company is an expert in Fortran at this point&#8212;even a modern dialect like Fortran 95<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>&#8212;we have been translating the whole thing to Python in order to start re-working pieces of it. (We&#8217;re using Python because that&#8217;s the company&#8217;s standard; we&#8217;re reworking this piece of code for reasons long and uninteresting.) The formal translation step was completed in mid-July; since then we have been working on refactoring the project so that we can actually <em>change</em> things without breaking everything.</p>
<p>The trick, of course, is all those global variables. In order to be able to begin making any other changes, we have to eliminate the global state. Otherwise, a change in one module can (and often does) have unexpected effects elsewhere.</p>
<p>Our strategy has been simple: take things in small steps, albeit often very <em>time-consuming</em> small steps. In each of those steps we have aimed to make single, incremental change that makes things more explicit and safer. Often, this has simply meant passing and returning inordinate numbers of variables back and forth to functions, simply so that the behavior is explicit (not to say clear). At other times, this has meant doing <em>very bad things</em> that would be intolerable under any other circumstances, but were less bad than what we had before and allowed us to step forward toward our ultimate goals. The prime example&#8212;and one of which I&#8217;m fairly proud, though I hope never to have to use it again&#8212;is leveraging Python&#8217;s property decorators to allow us to begin using struct-like objects for passing around large amounts of data before all the global state involved in said structs was eliminated.</p>
<p>Basically, we created a stopgap wrapper that made struct access result in changing global state. That way, functions could receive the struct and act on it, with the global state invisible to them: from any function&#8217;s perspective, it is performing perfectly normal access/mutation operations on the class fields. Behind the scenes, we manipulated global state, until we were able to eliminate global dependencies for that variable entirely, at which point we replaced the quirky behavior with standard field initialization.</p>
<p>Here is the <em>awful</em> pattern my colleague and I used as part of that transition, followed by some explanation. (Do not attempt at home!)</p>
<pre><code>class BasicallyAStruct():
    def __init__(self, some_field):
        global some_field_
        some_field_ = some_field

    @property
    def some_field(self):
        return some_field_

    @some_field.setter
    def some_field(self, value):
        global some_field_
        some_field = value
</code></pre>
<p>Here&#8217;s how it works. For starters, we renamed every global variable to end in an underscore (like <code>some_field_</code>) to make it easy to distinguish between global and local variables. Then, we created a class that is basically just a struct to hold data. (It can of course be expanded to be a full-up class with methods later if that makes sense.) In the constructor, we declare every global variable that the struct needs to reference, and then assign it the value passed to the constructor. Then we use Python&#8217;s property decorators to specify the access and mutation behavior: instead of storing the value to a class property like normal, calling the setter or getter<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup> actually returns or sets the value in the global variable. The result:</p>
<pre><code>global some_field_  # set to some old value
my_struct = BasicallyAStruct(some_field_)  # create the struct

# Set
my_struct.some_field = new_value  # assign just like normal
print(some_field_)  # new_value

# Get
print(new_value == my_struct.some_field)  # True
</code></pre>
<p>Once we get to a point where we&#8217;ve completely eliminated the global state, we change the class definition to look like a normal class definition, completely removing the <code>global</code> declaration and the <code>@property</code> and <code>@some_field.setter</code> decorators:</p>
<pre><code>class BasicallyAStruct():
    def __init__(self, some_field):
        self.some_field = some_field
</code></pre>
<p>From the functions using the struct, nothing has changed; they are already using standard class property access notation.</p>
<p>It has worked like a charm, and it demonstrates the power of decorators in a bit of an unusual situation. It is, of course, an <em>awful</em> use of decorators, to the extent that I would call it an abuse in general. If I ever found this in &#8220;final&#8221; code I would probably make a horrible noise in outrage; it&#8217;s a stupid thing to do. It is, however, <em>less</em> stupid than keeping everything global, and it made for a good intermediate solution that allowed us to minimize changes at each step along the way and therefore minimized the potential number of places anything could break as we refactored.<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup></p>
<p>I&#8217;m happy to say that almost all of those global variables are gone, and the classes are all looking pretty much like normal classes now. And the calling functions never even noticed.</p>
<p>I&#8217;m incredibly happy with how that came out&#8212;and I hope never to do anything like it again.</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn:1">
Experienced FORTRAN programmers will recognize the pattern: all the variables are declared in a common block at the top of every single function, except for a couple subroutines.&#160;<a href="#fnref:1" rev="footnote">&#8617;</a>
</li>
<li id="fn:2">
A fun piece of trivia: my first software development project was all Fortran 95. Fortran was what the physics professor who helped a bunch of students get their projects off the ground knew, so Fortran is where I started. A bit strangely, that background has ended up being valuable to two of my three employers so far.&#160;<a href="#fnref:2" rev="footnote">&#8617;</a>
</li>
<li id="fn:3">
Behind the scenes, Python&#8217;s property access always calls getter and setter methods&#8212;which is why you can override them as we are here. It&#8217;s a nifty bit of metaprogramming capability the language gives you.&#160;<a href="#fnref:3" rev="footnote">&#8617;</a>
</li>
<li id="fn:4">
This is actually a pretty good example of the principle of information hiding put to a non-standard use.&#160;<a href="#fnref:4" rev="footnote">&#8617;</a>
</li>
</ol>
</div>

            </div>

            
         </article>            <nav id="page-nav">
         <ul>
            <li class="newer">
                           </li>
            <li class="home"><a href="../../index.html">&ndash;Home&ndash;</a></li>
            <li class="older">
                           </li>
         </ul>
      </nav>
         </div>      <footer id="site-footer">

            <nav id="supersite-nav" class="footer-block">
         <h1>Navigate</h1>
         <ul>
            <li>
               <h2>Search this site:</h2>
               
<form role="search" class="customform" method="get" action="http://chriskrycho.com/web/">
   <input type="text" value="" name="search" id="search" placeholder="discover something"/>
   <input type="submit" id="searchsubmit" value="&rarr;" />
</form>            </li>
            <li>
               <a href="../../../index.html">Home</a><br/>
               <i>Creativity, reflection, & passionate endeavors.</i>
            </li>
            <li>
               <a href="../../index.html">Designgineering</a><br/>
               <i>Web design & development.</i>
            </li>
            <li>
               <a href="../../../theology/index.html">Ardent Fidelity</a><br/>
               <i>Reflections on a Christ-centered life.</i>
            </li>
            <li>
               <a href="../../../art/index.html">Ars Artis</a><br/>
               <i>Creations & musings on creativity.</i>
            </li>
            <li>
               <a href="../../../family/index.html">From the Hearth</a><br/>
               <i>Updates on our growing family.</i>
            </li>
         </ul>
      </nav>

      <section id="connect" class="footer-block">
         <h1>Connect</h1>
         <ul>
            <li><h2>Opt for emails:</h2>			<div class="textwidget"><form class="customform" action="http://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open('http://feedburner.google.com/fb/a/mailverify?uri=chriskrycho/web', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
<input type="text" name="email" placeholder="your.name@domain.com"/>
<input type="hidden" value="chriskrycho/web" name="uri"/>
<input type="hidden" name="loc" value="en_US"/>
<input type="submit" value="&rarr;" />
</form></div>
		</li>            <li>
               <a href="../../feed/index.html" title="RSS feed" target="_blank">RSS/Atom</a><br/>
               <i>To the feed reader, quick!</i>
            </li>
            <li>
               <a href='https://alpha.app.net/chriskrycho' rel='me' data-type='follow' data-user-id='@chriskrycho' title="app.net/chriskrycho">App.net</a><br/>
               <i>Less noisy, more characters.</i>
            </li>
            <li>
               <a href="#" class="email-link" title="chris|@|chriskrycho|.|com" target="_blank">Email</a><br/>
               <i>Send me a letter. But without the paper.</i>
            </li>
            <li>
               <a href="http://www.facebook.com/chriskrycho" title="facebook.com/chriskrycho" target="_blank">Facebook</a><br/>
               <i>Fun party meets family get-together.</i>
            </li>
            <li>
               <a href="https://plus.google.com/100517719789069874571/" title="Google+ profile" target="_blank">Google+</a><br/>
               <i>The nerdy new kid on the block.</i>
            </li>
            <li>
               <a href="http://www.goodreads.com/user/show/3165223-chris-krycho" title="Goodreads profile" target="_blank">Goodreads</a><br/>
               <i>A bookshelf, in cyberspace!</i>
            </li>
            <li>
               <a href="http://www.linkedin.com/in/chriskrycho" title="LinkedIn Profile" target="_blank">LinkedIn</a><br/>
               <i>A place for professional professionals.</i>
            </li>
            <li>
               <a href="http://nosegue.tumblr.com/">No Segue</a><br/>
               <i>A Tumblr about technology</i>
            </li>
            <li>
               <a href="http://www.twitter.com/chriskrycho" title="twitter.com/chriskrycho" target="_blank">Twitter</a><br/>
               <i>Your spastic journalist neighbors.</i>
            </li>
            <li>
               <a href="http://about.me/chriskrycho" title="About.me profile" target="_blank">About.me</a><br/>
               <i>Biographical sundries & links galore!</i>
            </li>
            <li>
               <a href="http://www.runningahead.com/logs/2667b469aeda433382cbcc8ed413d964/profile" target="_blank">RunningAhead</a><br/>
               <i>I run and run and run some more.</i>
            </li>
         </ul>
      </section>

      <section id="read" class="footer-block">
         <h1>Read</h1>
         <div class="eg-archives-columns"><ul>	<li><a href='../../2013/12/index.html'>December 2013</a></li>
	<li><a href='../../2013/10/index.html'>October 2013</a></li>
	<li><a href='../../2013/09/index.html'>September 2013</a></li>
	<li><a href='../../2013/08/index.html'>August 2013</a></li>
	<li><a href='../../2013/06/index.html'>June 2013</a></li>
	<li><a href='../../2013/05/index.html'>May 2013</a></li>
	<li><a href='../../2013/03/index.html'>March 2013</a></li>
	<li><a href='../../2013/02/index.html'>February 2013</a></li>
	<li><a href='../../2013/01/index.html'>January 2013</a></li>
	<li><a href='../../2012/12/index.html'>December 2012</a></li>
	<li><a href='../../2012/11/index.html'>November 2012</a></li>
</ul><ul>
	<li><a href='../../2012/10/index.html'>October 2012</a></li>
	<li><a href='../../2012/09/index.html'>September 2012</a></li>
	<li><a href='../../2012/08/index.html'>August 2012</a></li>
	<li><a href='../../2012/07/index.html'>July 2012</a></li>
	<li><a href='../../2012/06/index.html'>June 2012</a></li>
	<li><a href='../../2012/05/index.html'>May 2012</a></li>
	<li><a href='../../2012/04/index.html'>April 2012</a></li>
	<li><a href='../../2012/03/index.html'>March 2012</a></li>
	<li><a href='../../2012/02/index.html'>February 2012</a></li>
	<li><a href='../../2012/01/index.html'>January 2012</a></li></ul></div>      </section>

      <section id="discuss" class="footer-block">
         <h1>Discuss</h1>
         <h2></h2><ul><li><a href="../../python-homebrew-virtualenv-os-x-framework-builds/index.html#comment-16469">Josh, another bit of follow-up. As noted in my prev...</a> &ndash; Chris Krycho <i>on <a href="../../python-homebrew-virtualenv-os-x-framework-builds/index.html">Python—homebrew, virtualenv, and OS X Framework builds</a></i></li><li><a href="../../modular-scales-fantastic-but-dont-overdo-it/index.html#comment-15318">z6305

c17217

R10941
</a> &ndash; VedqueltWeree <i>on <a href="../../modular-scales-fantastic-but-dont-overdo-it/index.html">Modular scales: fantastic, but don't overdo it</a></i></li><li><a href="../../python-homebrew-virtualenv-os-x-framework-builds/index.html#comment-15073">My pleasure. However, fair warning: I just discover...</a> &ndash; Chris Krycho <i>on <a href="../../python-homebrew-virtualenv-os-x-framework-builds/index.html">Python—homebrew, virtualenv, and OS X Framework builds</a></i></li><li><a href="../../python-homebrew-virtualenv-os-x-framework-builds/index.html#comment-14916">Thank you.  This was a source of much frustration.
...</a> &ndash; Josh Baylin <i>on <a href="../../python-homebrew-virtualenv-os-x-framework-builds/index.html">Python—homebrew, virtualenv, and OS X Framework builds</a></i></li><li><a href="../../jira-confluence-intranets-and-windows-firewall/index.html#comment-11602">Thank you so much for this awesome post! I've been ...</a> &ndash; Henrik Olsen <i>on <a href="../../jira-confluence-intranets-and-windows-firewall/index.html">JIRA, Confluence, Intranets and Windows Firewall</a></i></li></ul>      </section>

      <section id="colophon" class="colophon footer-block">
         <h1>Colophon</h1>
         <p>
            &copy;2012&ndash;2014 Chris Krycho         </p>
               </section>
   </footer>
   <!-- MathJax Latex Plugin installed: Disabled as no shortcodes on this page --><script src="http://bible.logos.com/jsapi/Referencetagging.js" type="text/javascript"></script>
<script type="text/javascript">
			Logos.ReferenceTagging.lbsBibleVersion = "";
			Logos.ReferenceTagging.lbsLibronixBibleVersion = "";
									Logos.ReferenceTagging.lbsLibronixLinkIcon = "";
			Logos.ReferenceTagging.lbsNoSearchClassNames = [ "commentlist" ];			Logos.ReferenceTagging.lbsUseTooltip = false;			Logos.ReferenceTagging.lbsNoSearchTagNames = [  ];
															Logos.ReferenceTagging.tag();
		</script>
   <script src='https://d2zh9g63fcvyrq.cloudfront.net/adn.js'></script>
</body>

<!-- Mirrored from chriskrycho.com/web/topics/decorators/ by HTTrack Website Copier/3.x [XR&CO'2013], Wed, 01 Jan 2014 02:58:34 GMT -->
</html>